<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VALO Lineups ‚Äî SPA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#0b0d13;--panel:#131824;--card:#0f1420;--border:#1f2738;
    --text:#e9eef5;--muted:#9aa4b2;--primary:#ff4655;--primary-700:#c93643;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(180deg,#0a0d12,#0b0d13 30%,#0b0d13)}
  a{color:inherit}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .hidden{display:none!important}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:50;background:rgba(11,13,19,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .topbar-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:7px;background:linear-gradient(135deg,var(--primary),#ff8a9a);box-shadow:0 0 0 2px #0006,0 6px 16px #0008}
  .search{flex:1;display:flex;gap:8px;max-width:560px;margin:0 16px}
  .search input,.select{flex:1;background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  .btn{background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;border:0;cursor:pointer;transition:.2s}
  .btn:hover{background:var(--primary-700)}
  .btn.ghost{background:transparent;border:1px solid var(--border)}
  .muted{color:var(--muted);font-size:12px}

  /* Auth */
  .auth{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .card h2{margin:0 0 8px}
  .field{display:grid;gap:6px;margin-bottom:10px}
  .field input,.field select,.field textarea{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px}

  /* Grid/Feed */
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:768px){
    .topbar-inner{flex-direction:column;align-items:stretch;gap:12px}
    .brand{justify-content:center}
    .search{flex-direction:column;max-width:100%;margin:0}
    .auth{grid-template-columns:1fr}
    .grid{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:600px){.grid{grid-template-columns:1fr}}

  .card-post{position:relative;overflow:hidden;border-radius:16px;background:linear-gradient(180deg,#12192a,#0e1523);border:1px solid var(--border)}
  .thumb{aspect-ratio:16/9;background:#0c121f center/cover}
  .meta{display:flex;align-items:center;justify-content:space-between;padding:12px}
  .title{font-weight:700}
  .author{color:var(--muted);font-size:12px}
  .likes{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
  .pills{display:flex;gap:8px;flex-wrap:wrap;margin:0 12px 12px}
  .pill{font-size:11px;border:1px solid var(--border);background:var(--card);padding:6px 8px;border-radius:999px;color:var(--muted)}

  /* Fab */
  .fab{position:fixed;right:20px;bottom:20px;background:var(--primary);color:#fff;border-radius:16px;padding:12px 14px;display:flex;gap:8px;align-items:center;box-shadow:0 10px 30px #0008}
  .fab[disabled]{opacity:.6;cursor:not-allowed}

  /* Modals */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0007;backdrop-filter:blur(4px);z-index:100}
  .modal.show{display:flex}
  .modal-card{width:min(100%,900px);max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:16px}
  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
  .modal-body{padding:16px}

  .split{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}
  .video{aspect-ratio:16/9;width:100%;border:0;border-radius:12px;background:#000}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:6px;align-items:center;background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:999px}
  .chip .n{color:#fff;font-weight:700}
  .chip.good{border-color:#143d2a;background:#0c251b}
  .chip.bad{border-color:#3d1414;background:#250c0c}

  .comments{display:grid;gap:10px}
  .comment{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
  .comment .by{color:var(--muted);font-size:12px}

  /* Forgot password steps */
  .fp-step{display:grid;gap:12px}
  .fp-step.hidden{display:none}

  /* Admin */
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px;text-align:left}
  th{background:var(--card)}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner container">
    <div class="brand"><div class="logo" aria-hidden="true"></div><h1>VALO Lineups</h1></div>
    <div class="search">
      <input id="q" placeholder="Buscar por agente, mapa ou t√≠tulo‚Ä¶"/>
      <select id="filterAgent" class="select"><option value="">Agente</option></select>
      <select id="filterMap" class="select"><option value="">Mapa</option></select>
      <select id="filterSort" class="select" title="Ordena√ß√£o">
        <option value="smart">Prioridade: data + engajamento</option>
        <option value="recent">Mais recentes</option>
        <option value="trending">Mais engajamento</option>
      </select>
    </div>
    <div id="authArea"></div>
  </div>
</header>

<main class="container">
  <section id="authView" class="auth"></section>

  <section id="feedView" class="hidden">
    <div id="emptyState" class="card" style="display:none;text-align:center">
      <h3>Nenhum lineup ainda</h3>
      <p class="muted">Seja o primeiro a compartilhar um setup, p√≥s-plant, pixel, etc.</p>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <section id="adminView" class="hidden"></section>
</main>

<!-- New Post Modal -->
<div id="postModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card" style="width:min(100%,720px)">
    <div class="modal-head">
      <strong>Novo lineup</strong>
      <button class="btn ghost" data-close="#postModal">Fechar</button>
    </div>
    <div class="modal-body">
      <div class="field"><label>Agente</label><select id="fAgent"></select></div>
      <div class="field"><label>Mapa</label><select id="fMap"></select></div>
      <div class="field"><label>URL do YouTube (https://‚Ä¶)</label><input id="fUrl" placeholder="https://www.youtube.com/watch?v=‚Ä¶"/></div>
      <div class="field"><label>T√≠tulo</label><input id="fTitle" placeholder="T√≠tulo curto e claro"/></div>
      <div class="field"><label>Descri√ß√£o</label><textarea id="fDesc" rows="4" placeholder="Explique o setup (posi√ß√£o, pixel, utilit√°ria, etc.)"></textarea></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn ghost" data-close="#postModal">Cancelar</button>
        <button id="savePost" class="btn">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- View Post Modal -->
<div id="viewModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-head">
      <div style="display:flex;gap:12px;align-items:center">
        <strong id="vmTitle">T√≠tulo</strong>
        <span class="pill" id="vmMeta"></span>
      </div>
      <button class="btn ghost" data-close="#viewModal">Fechar</button>
    </div>
    <div class="modal-body split">
      <div>
        <iframe id="vmPlayer" class="video" allowfullscreen title="Video"></iframe>
        <div class="pills" id="vmPills"></div>
        <div style="margin-top:12px" class="actions">
          <button class="chip good" id="btnLike" title="Curtir">üëç <span class="n" id="vmLikes">0</span></button>
          <button class="chip bad" id="btnDislike" title="N√£o curtir">üëé <span class="n" id="vmDislikes">0</span></button>
          <span class="chip">üëÅÔ∏è <span class="n" id="vmViews">0</span></span>
        </div>
        <p id="vmDesc" class="muted" style="margin-top:8px"></p>
      </div>
      <aside>
        <h3 style="margin:0 0 8px">Coment√°rios</h3>
        <div id="comments" class="comments"></div>
        <div id="commentForm" class="field" style="margin-top:8px">
          <label>Escreva um coment√°rio</label>
          <input id="commentText" placeholder="Seja respeitoso. Dicas s√£o bem-vindas."/>
          <button id="sendComment" class="btn">Comentar</button>
        </div>
      </aside>
    </div>
  </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgotModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card" style="width:min(100%,480px)">
    <div class="modal-head">
      <strong>Recuperar senha</strong>
      <button class="btn ghost" data-close="#forgotModal">Fechar</button>
    </div>
    <div class="modal-body">
      <div id="fpStep1" class="fp-step">
        <div class="field"><label>Usu√°rio</label><input id="fpUser" placeholder="Digite seu usu√°rio"/></div>
        <button id="fpNext" class="btn">Avan√ßar</button>
      </div>
      <div id="fpStep2" class="fp-step hidden">
        <div class="field"><label id="fpQuestion">Pergunta secreta</label><input id="fpAnswer" placeholder="Sua resposta"/></div>
        <button id="fpCheck" class="btn">Validar</button>
      </div>
      <div id="fpStep3" class="fp-step hidden">
        <div class="field"><label>Nova senha</label><input id="fpNewPass" type="password" placeholder="M√≠nimo 8 caracteres (Aa1!)"/></div>
        <button id="fpSave" class="btn">Salvar senha</button>
      </div>
    </div>
  </div>
</div>

<button id="fab" class="fab" disabled>Ôºã Postar lineup</button>

<script>
  // ---------------- Data / Storage ----------------
  const AGENTS=["Sova","Viper","Brimstone","Killjoy","Cypher","Sage","Omen","Astra","Phoenix","Jett","Raze","Skye","KAY/O","Fade","Gekko","Harbor","Iso","Clove","Deadlock","Breach","Neon","Yoru","Reyna"];
  const MAPS=["Ascent","Bind","Haven","Split","Lotus","Pearl","Icebox","Fracture","Breeze","Sunset"];
  const LS={
    users:()=>JSON.parse(localStorage.getItem("valo_users")||"[]"),
    saveUsers:(a)=>localStorage.setItem("valo_users",JSON.stringify(a)),
    me:()=>JSON.parse(localStorage.getItem("valo_session")||"null"),
    setMe:(u)=>localStorage.setItem("valo_session",JSON.stringify(u)),
    posts:()=>JSON.parse(localStorage.getItem("valo_posts")||"[]"),
    savePosts:(a)=>localStorage.setItem("valo_posts",JSON.stringify(a)),
  };
  const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  let STATE={q:"",agent:"",map:"",sort:"smart"};
  let CURRENT_VIEW_ID=null;
  let RECOVER_USER=null;

  // ---------------- Helpers ----------------
  function fillSelect(el,opts,placeholder){ el.innerHTML = (placeholder?`<option value="">${placeholder}</option>`:"")+opts.map(o=>`<option>${o}</option>`).join(""); }
  function isYoutube(url){ try{const u=new URL(url);return /youtube\.com|youtu\.be/.test(u.hostname);}catch{return false;} }
  function toEmbed(url){
    try{const u=new URL(url);
      if(u.hostname.includes("youtu.be")){const id=u.pathname.slice(1);return `https://www.youtube.com/embed/${id}`;}
      const id=u.searchParams.get("v"); if(id) return `https://www.youtube.com/embed/${id}`;
    }catch{}
    return 'about:blank';
  }
  function thumbFromUrl(url){
    try{const u=new URL(url); let id="";
      if(u.hostname.includes("youtu.be")) id=u.pathname.slice(1); else id=u.searchParams.get("v")||"";
      return id?`https://i.ytimg.com/vi/${id}/hqdefault.jpg`:'https://i.ytimg.com/vi/5qap5aO4i9A/hqdefault.jpg';
    }catch{return 'https://i.ytimg.com/vi/5qap5aO4i9A/hqdefault.jpg';}
  }
  function escapeHtml(s){return s.replace(/[&<>"]+/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}
  function formatDate(ts){const d=new Date(ts);return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;}
  function dayBucket(ts){const a=new Date();a.setHours(0,0,0,0);const b=new Date(ts);b.setHours(0,0,0,0);return Math.round((a-b)/86400000);}
  function score(p){const likes=p.likes?.length||0,dislikes=p.dislikes?.length||0,comments=p.comments?.length||0,views=p.views||0;return likes*3+comments*4+views*0.1-dislikes*2;}
  function sortPosts(arr,mode){
    return arr.slice().sort((a,b)=>{
      if(mode==="recent") return b.createdAt-a.createdAt;
      if(mode==="trending") return score(b)-score(a) || (b.createdAt-a.createdAt);
      const d = dayBucket(a.createdAt)-dayBucket(b.createdAt);
      if(d!==0) return d;
      const s = score(b)-score(a); if(s!==0) return s;
      return b.createdAt-a.createdAt;
    });
  }

  // ---------------- UI Mount ----------------
  function renderAuthArea(){
    const me=LS.me(); const area=document.getElementById('authArea');
    if(me){
      let adminBtn = me.username==="admin"?` <button id="openAdmin" class="btn ghost">Admin</button>`:"";
      area.innerHTML = `<span class="muted">Ol√°, <strong>${escapeHtml(me.username)}</strong></span>${adminBtn} <button id="logout" class="btn ghost">Sair</button>`;
      document.getElementById('logout').onclick=()=>{ LS.setMe(null); mount(); };
      if(me.username==="admin"){ document.getElementById('openAdmin').onclick=showAdmin; }
      document.getElementById('fab').disabled=false;
    }else{
      area.innerHTML = `<button id="openAuth" class="btn">Entrar / Cadastrar</button>`;
      document.getElementById('openAuth').onclick=showAuth;
      document.getElementById('fab').disabled=true;
    }
  }

  function showAuth(){
    const el=document.getElementById('authView'), feed=document.getElementById('feedView'), admin=document.getElementById('adminView');
    el.classList.remove('hidden'); feed.classList.add('hidden'); admin.classList.add('hidden');

    el.innerHTML = `
      <div class="card">
        <h2>Entrar</h2>
        <div class="field"><label>Usu√°rio</label><input id="liUser" placeholder="nick#123"/></div>
        <div class="field"><label>Senha</label><input id="liPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
        <button id="btnLogin" class="btn">Entrar</button>
        <p><a href="#" id="forgotPass" class="muted">Esqueci minha senha</a></p>
      </div>
      <div class="card">
        <h2>Cadastrar</h2>
        <div class="field"><label>Usu√°rio</label><input id="suUser" placeholder="nick#123"/></div>
        <div class="field"><label>Senha</label><input id="suPass" type="password" placeholder="M√≠nimo 8 (Aa1!)"/></div>
        <div class="field">
          <label>Pergunta secreta</label>
          <select id="suQuestion">
            <option value="">Selecione uma pergunta</option>
            <option>Qual o nome do seu primeiro animal de estima√ß√£o?</option>
            <option>Qual a cidade onde voc√™ nasceu?</option>
            <option>Qual era o nome da sua escola prim√°ria?</option>
            <option>Qual a sua comida favorita?</option>
          </select>
        </div>
        <div class="field"><label>Resposta</label><input id="suAnswer" placeholder="Resposta secreta"/></div>
        <button id="btnSignup" class="btn">Cadastrar</button>
      </div>
    `;

    document.getElementById('btnLogin').onclick=()=>{
      const u=document.getElementById('liUser').value.trim();
      const p=document.getElementById('liPass').value;
      if(!u||!p) return alert("Preencha usu√°rio e senha.");
      const users=LS.users();
      const found=users.find(x=>x.username===u && x.password===p);
      if(found || u==="admin"){ LS.setMe({id:found?found.id:uid(),username:u}); mount(); }
      else alert("Usu√°rio ou senha inv√°lidos.");
    };

    document.getElementById('btnSignup').onclick=()=>{
      const u=document.getElementById('suUser').value.trim();
      const p=document.getElementById('suPass').value;
      const q=document.getElementById('suQuestion').value;
      const a=document.getElementById('suAnswer').value.trim();
      if(u.length<3) return alert("Usu√°rio deve ter pelo menos 3 caracteres.");
      const strong = p.length>=8 && /\d/.test(p) && /[A-Z]/.test(p) && /[a-z]/.test(p) && /[!@#$%^&*(),.?\":{}|<>]/.test(p);
      if(!strong) return alert("Senha fraca. Use ‚â•8 com mai√∫scula, min√∫scula, n√∫mero e especial.");
      if(!q || !a) return alert("Selecione uma pergunta secreta e preencha a resposta.");
      const users=LS.users();
      if(users.some(x=>x.username===u)) return alert("Usu√°rio j√° existe.");
      const nu={id:uid(),username:u,password:p,question:q,answer:a.toLowerCase(),createdAt:Date.now()};
      users.push(nu); LS.saveUsers(users); LS.setMe({id:nu.id, username:nu.username}); mount();
    };

    document.getElementById('forgotPass').onclick=(e)=>{
      e.preventDefault();
      openForgotModal();
    };
  }

  function showFeed(){
    document.getElementById('authView').classList.add('hidden');
    document.getElementById('adminView').classList.add('hidden');
    document.getElementById('feedView').classList.remove('hidden');
    renderGrid();
  }

  function showAdmin(){
    const me=LS.me(); if(!me || me.username!=="admin"){ return alert("Acesso restrito ao admin."); }
    document.getElementById('authView').classList.add('hidden');
    document.getElementById('feedView').classList.add('hidden');
    const root=document.getElementById('adminView'); root.classList.remove('hidden');

    const users=LS.users(), posts=LS.posts();
    root.innerHTML = `
      <div class="card"><h2>Painel Admin</h2>
        <h3>Usu√°rios</h3>
        <table>
          <tr><th>Usu√°rio</th><th>Criado em</th><th>A√ß√µes</th></tr>
          ${users.map(u=>`
            <tr>
              <td>${escapeHtml(u.username)}</td>
              <td>${u.createdAt?formatDate(u.createdAt):'-'}</td>
              <td>
                <button class="btn ghost" data-reset="${u.id}">Reset senha</button>
                ${u.username!=="admin"?`<button class="btn ghost" data-deluser="${u.id}">Excluir</button>`:""}
              </td>
            </tr>
          `).join('')}
        </table>

        <h3 style="margin-top:16px">Posts</h3>
        <table>
          <tr><th>T√≠tulo</th><th>Autor</th><th>Agente</th><th>Mapa</th><th>Data</th><th>A√ß√µes</th></tr>
          ${posts.map(p=>`
            <tr>
              <td>${escapeHtml(p.title)}</td>
              <td>${escapeHtml(p.author)}</td>
              <td>${escapeHtml(p.agent)}</td>
              <td>${escapeHtml(p.map)}</td>
              <td>${formatDate(p.createdAt)}</td>
              <td><button class="btn ghost" data-delpost="${p.id}">Excluir</button></td>
            </tr>
          `).join('')}
        </table>
      </div>
    `;

    // a√ß√µes
    root.querySelectorAll('[data-reset]').forEach(b=>b.onclick=()=>{
      const id=b.dataset.reset; const all=LS.users(); const i=all.findIndex(u=>u.id===id);
      if(i>=0){ all[i].password='Reset@123'; LS.saveUsers(all); alert('Senha resetada para: Reset@123'); }
    });
    root.querySelectorAll('[data-deluser]').forEach(b=>b.onclick=()=>{
      const id=b.dataset.deluser;
      const all=LS.users().filter(u=>u.id!==id);
      LS.saveUsers(all);
      if(LS.me() && LS.me().id===id){ LS.setMe(null); }
      showAdmin();
    });
    root.querySelectorAll('[data-delpost]').forEach(b=>b.onclick=()=>{
      const id=b.dataset.delpost;
      LS.savePosts(LS.posts().filter(p=>p.id!==id));
      showAdmin();
    });
  }

  // ---------------- Feed / Grid ----------------
  function renderGrid(){
    const grid=document.getElementById('grid'); const posts=LS.posts();
    // filtros
    const filtered = posts.filter(p=>{
      if(STATE.agent && p.agent!==STATE.agent) return false;
      if(STATE.map && p.map!==STATE.map) return false;
      if(STATE.q){
        const q=STATE.q.toLowerCase();
        const hay=(p.title+" "+p.description+" "+p.agent+" "+p.map+" "+p.author).toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
    const sorted = sortPosts(filtered, STATE.sort);
    document.getElementById('emptyState').style.display = sorted.length? 'none':'block';
    grid.innerHTML = sorted.map(p=>`
      <article class="card-post" data-id="${p.id}">
        <div class="thumb" style="background-image:url('${thumbFromUrl(p.url)}')"></div>
        <div class="meta">
          <div>
            <div class="title">${escapeHtml(p.title)}</div>
            <div class="author">por ${escapeHtml(p.author)} ¬∑ ${formatDate(p.createdAt)}</div>
          </div>
          <div class="likes" title="Engajamento">
            <span>üëç ${p.likes?.length||0}</span>
            <span>üí¨ ${p.comments?.length||0}</span>
            <span>üëÅÔ∏è ${p.views||0}</span>
          </div>
        </div>
        <div class="pills">
          <span class="pill">${escapeHtml(p.agent)}</span>
          <span class="pill">${escapeHtml(p.map)}</span>
        </div>
      </article>
    `).join('');

    grid.querySelectorAll('.card-post').forEach(card=>{
      card.onclick = ()=> openView(card.dataset.id);
    });
  }

  // ---------------- Create / View Post ----------------
  document.getElementById('fab').onclick=()=>{
    if(!LS.me()) return alert('Fa√ßa login para postar.');
    openModal('#postModal');
  };
  document.getElementById('savePost').onclick=()=>{
    const me=LS.me(); if(!me) return alert('Login necess√°rio.');
    const agent=document.getElementById('fAgent').value;
    const map=document.getElementById('fMap').value;
    const url=document.getElementById('fUrl').value.trim();
    const title=document.getElementById('fTitle').value.trim();
    const description=document.getElementById('fDesc').value.trim();
    if(!agent||!map||!url||!title) return alert('Preencha agente, mapa, URL e t√≠tulo.');
    if(!isYoutube(url)) return alert('Informe uma URL v√°lida do YouTube.');

    const all=LS.posts();
    all.push({id:uid(),author:me.username,authorId:me.id,agent,map,url,title,description,createdAt:Date.now(),likes:[],dislikes:[],views:0,comments:[]});
    LS.savePosts(all);
    closeModal('#postModal');
    ['fAgent','fMap','fUrl','fTitle','fDesc'].forEach(id=>document.getElementById(id).value='');
    renderGrid();
  };

  function openView(id){
    const all=LS.posts(); const p=all.find(x=>x.id===id); if(!p) return;
    CURRENT_VIEW_ID=id;
    document.getElementById('vmTitle').textContent=p.title;
    document.getElementById('vmMeta').textContent=`${p.agent} ‚Ä¢ ${p.map} ‚Ä¢ ${formatDate(p.createdAt)}`;
    document.getElementById('vmPlayer').src=toEmbed(p.url);
    document.getElementById('vmLikes').textContent=p.likes.length;
    document.getElementById('vmDislikes').textContent=p.dislikes.length;
    document.getElementById('vmViews').textContent=p.views;
    document.getElementById('vmDesc').textContent=p.description||'';
    document.getElementById('vmPills').innerHTML=`<span class="pill">Autor: ${escapeHtml(p.author)}</span>`;
    renderComments(p);

    const me=LS.me();
    if(me){ p.views=(p.views||0)+1; savePost(p); document.getElementById('vmViews').textContent=p.views; }

    document.getElementById('btnLike').onclick=()=>toggleReaction('like');
    document.getElementById('btnDislike').onclick=()=>toggleReaction('dislike');
    document.getElementById('sendComment').onclick=()=>{
      const me=LS.me(); if(!me) return alert('Fa√ßa login para comentar.');
      const txt=document.getElementById('commentText').value.trim(); if(!txt) return;
      const all=LS.posts(); const idx=all.findIndex(x=>x.id===CURRENT_VIEW_ID); if(idx<0)return;
      all[idx].comments.push({id:uid(),by:me.username,byId:me.id,text:txt,at:Date.now()});
      LS.savePosts(all);
      document.getElementById('commentText').value='';
      renderComments(all[idx]);
      renderGrid();
    };

    openModal('#viewModal');
  }

  function renderComments(p){
    const box=document.getElementById('comments');
    if(!p.comments.length){ box.innerHTML='<div class="muted">Seja o primeiro a comentar.</div>'; return; }
    box.innerHTML = p.comments.slice().sort((a,b)=>a.at-b.at).map(c=>`
      <div class="comment">
        <div class="by">${escapeHtml(c.by)} ¬∑ ${formatDate(c.at)}</div>
        <div>${escapeHtml(c.text)}</div>
      </div>
    `).join('');
  }

  function toggleReaction(kind){
    const me=LS.me(); if(!me) return alert('Fa√ßa login para reagir.');
    const all=LS.posts(); const p=all.find(x=>x.id===CURRENT_VIEW_ID); if(!p) return;
    p.likes=p.likes||[]; p.dislikes=p.dislikes||[];
    // remove de ambos primeiro (uma √∫nica rea√ß√£o por usu√°rio)
    p.likes = p.likes.filter(u=>u!==me.id);
    p.dislikes = p.dislikes.filter(u=>u!==me.id);
    if(kind==='like') p.likes.push(me.id); else p.dislikes.push(me.id);
    LS.savePosts(all);
    document.getElementById('vmLikes').textContent=p.likes.length;
    document.getElementById('vmDislikes').textContent=p.dislikes.length;
    renderGrid();
  }

  function savePost(p){
    const all=LS.posts(); const i=all.findIndex(x=>x.id===p.id);
    if(i>=0){ all[i]=p; LS.savePosts(all); }
  }

  // ---------------- Forgot Password (Modal) ----------------
  function openForgotModal(){
    openModal('#forgotModal');
    document.querySelectorAll('#forgotModal .fp-step').forEach(s=>s.classList.add('hidden'));
    document.getElementById('fpStep1').classList.remove('hidden');
    ['fpUser','fpAnswer','fpNewPass'].forEach(id=>document.getElementById(id).value='');
    RECOVER_USER=null;
  }
  document.getElementById('fpNext').onclick=()=>{
    const username=document.getElementById('fpUser').value.trim();
    const found=LS.users().find(u=>u.username===username);
    if(!found) return alert('Usu√°rio n√£o encontrado.');
    RECOVER_USER=found;
    document.getElementById('fpQuestion').textContent=found.question||'Pergunta n√£o definida';
    document.getElementById('fpStep1').classList.add('hidden');
    document.getElementById('fpStep2').classList.remove('hidden');
  };
  document.getElementById('fpCheck').onclick=()=>{
    const a=document.getElementById('fpAnswer').value.trim().toLowerCase();
    if(!RECOVER_USER) return;
    if(a===RECOVER_USER.answer){
      document.getElementById('fpStep2').classList.add('hidden');
      document.getElementById('fpStep3').classList.remove('hidden');
    }else alert('Resposta incorreta.');
  };
  document.getElementById('fpSave').onclick=()=>{
    const p=document.getElementById('fpNewPass').value;
    const strong = p.length>=8 && /\d/.test(p) && /[A-Z]/.test(p) && /[a-z]/.test(p) && /[!@#$%^&*(),.?":{}|<>]/.test(p);
    if(!strong) return alert('Senha fraca. Use ‚â•8 com Aa1!.');
    const users=LS.users(); const i=users.findIndex(u=>u.id===RECOVER_USER.id);
    if(i>=0){ users[i].password=p; LS.saveUsers(users); closeModal('#forgotModal'); alert('Senha alterada com sucesso!'); }
  };

  // ---------------- Filters / Events ----------------
  document.getElementById('q').addEventListener('input',(e)=>{STATE.q=e.target.value;renderGrid();});
  document.getElementById('filterAgent').addEventListener('change',(e)=>{STATE.agent=e.target.value;renderGrid();});
  document.getElementById('filterMap').addEventListener('change',(e)=>{STATE.map=e.target.value;renderGrid();});
  document.getElementById('filterSort').addEventListener('change',(e)=>{STATE.sort=e.target.value;renderGrid();});

  // ---------------- Modal helpers ----------------
  function openModal(sel){ document.querySelector(sel).classList.add('show'); }
  function closeModal(sel){ const m=document.querySelector(sel); m.classList.remove('show'); if(sel==='#viewModal') document.getElementById('vmPlayer').src='about:blank'; }
  document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',e=>closeModal(e.currentTarget.dataset.close)));
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); document.getElementById('vmPlayer').src='about:blank'; }});
  document.querySelectorAll('.modal').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('show'); }));

  // ---------------- Init ----------------
  function mount(){
    // fill selects
    fillSelect(document.getElementById('filterAgent'),AGENTS,'Agente');
    fillSelect(document.getElementById('filterMap'),MAPS,'Mapa');
    fillSelect(document.getElementById('fAgent'),AGENTS,'Agente');
    fillSelect(document.getElementById('fMap'),MAPS,'Mapa');

    renderAuthArea();
    const me=LS.me();
    if(me){ showFeed(); } else { showAuth(); }
  }
  mount();
</script>
</body>
</html>
